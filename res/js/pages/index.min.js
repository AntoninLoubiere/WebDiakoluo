

/* ################################### list.js ####################################*/

const listPage = document.getElementById('list-page');

function reloadTestList() {
    var testList = document.getElementById('test-list');
    while (testList.children.length) {
        testList.removeChild(testList.children[0]);
    }
    forEachHeader().onsuccess = function(event) {
        var cursor = event.target.result;
        if (cursor) {
            var t = document.getElementById('test-child-template').content.cloneNode(true);
            var v = cursor.value;
            var id = cursor.value.id;
            t.querySelector('.test-title').textContent = v.title;
            t.querySelector('.test-description').textContent = v.description;
            t.children[0].onclick = function() {
                const url = new URL(window.location);
                url.searchParams.set('page', 'view');
                url.searchParams.set('test', id);
                window.history.pushState({}, 'View page', url);
                loadPage();
            }
            testList.appendChild(t);
            cursor.continue();
        }
    };
}

function loadListPage() {
    currentPage = listPage;
    currentPage.classList.remove('hide');
    updatePageTitle('title-index.html');
    reloadTestList();
}

/* ################################### main.js ####################################*/

const MAIN_URL = "/WebDiakoluo/index.html"

var currentPage = null;
var currentTest = null;

function initNavigation() {
    window.onpopstate = function() {
        loadPage();
    }
    document.getElementById('loading-page').classList.add('hide');
    loadPage();
}

function loadPage() {
    const url = new URL(window.location);
    var page = url.searchParams.get('page');
    if (currentPage) {
        currentPage.classList.add('hide');
    }

    if (page == 'view') {
        loadPageRequiringTest(url, page);
    } else {
        loadListPage();
    }
}

function loadPageRequiringTest(url, page) {
    var testId = Number(url.searchParams.get('test'));
    if (testId) {
        if (!currentTest || testId != currentTest.id) {
            getFullTest(testId).onsuccess = function(event) {
                var test = event.target.result;
                if (test) {
                    currentTest = test;
                    loadPageRequiringTestCallback(page);
                } else {
                    backToList();
                }
            };
        } else {
            loadPageRequiringTestCallback(page);
        }
    } else {
        backToList();
    }
}

function loadPageRequiringTestCallback(page) {
    if (page == 'view') {
        loadViewPage();
    }
}

function backToList(newState = false) {
    if (newState) {
        window.history.pushState({}, 'Main page', MAIN_URL);
    } else {
        window.history.replaceState({}, 'Main page', MAIN_URL);
    }
    loadPage();
}

testDBCallbacks.push(initNavigation);

/* ################################### view.js ####################################*/

const viewPage = document.getElementById('view-page');

const viewPageTitle = [document.getElementById('test-title'), document.getElementById('test-title2')];
const viewPageDescription = document.getElementById('test-description');
const viewPageCreatedDate = document.getElementById('test-created-date');
const viewPageModificationDate = document.getElementById('test-modification-date');

function loadViewPage() {
    currentPage = viewPage;
    for (var i = 0; i < viewPageTitle.length; i++) {
        viewPageTitle[i].textContent = currentTest.title;
    }
    viewPageDescription.textContent = currentTest.description;
    viewPageCreatedDate.textContent = DATE_FORMATER.format(currentTest.createdDate);
    viewPageModificationDate.textContent = DATE_FORMATER.format(currentTest.modificationDate);
    currentPage.classList.remove('hide');

    setPageTitle(currentTest.title);
}