

/* ############################# res/js/pages/page.js #############################*/

/**
 * The abstract class that represent a UI panel that can be shown.
 */
class Page {
    /**
     * Create a new page.
     * @param {HTMLElement} pageView The page element to show / hide
     * @param {string} pageName The name of the page
     * @param {boolean} requireTest If it required  test to be loaded
     */
    constructor(pageView, pageName, requireTest) {
        this.page = pageView;
        this.pageName = pageName;
        this.requireTest = requireTest;
    }

    /**
     * Hide the page.
     */
    hide() {
        this.page?.classList.add('hide');
        this.ondelete?.();
    }

    /**
     * When the page is loaded.
     */
    onload() {
        I18N.updatePageTitle('title-' + this.pageName);
        this.page.classList.remove('hide');
    }
}

/* ############################# res/js/pages/main.js #############################*/

const MAIN_URL = "/WebDiakoluo/index.html"

var PAGES = {};

var currentURL = new URL(window.location)
var currentPage = new Page(null, null);
var currentPageName = null;
var currentTest = null;

/* init navigation */
async function initNavigation() {
    await I18N.initAsyncFunc;
    await DATABASE_MANAGER.initAsyncFunc;
    window.onpopstate = function() {
        if (Modal.currentModal && Modal.currentModal.dismiss) {
            Modal.currentModal.hide(false);
        } else {
            loadPage();
        }
    }
    document.getElementById('loading-page').classList.add('hide');
    loadPage();
}

/* load a page / process the ur l*/
function loadPage() {
    currentURL = new URL(window.location);
    var page = currentURL.searchParams.get('page') || "";
    if (page && currentPage.pageName == page) {
        if (currentPage.onupdate) {
            console.debug("Update page", page);
            if (currentPage.requireTest) loadPageRequiringTest(true);
            else currentPage.onupdate?.();
        }
    } else {
        console.debug("Load page", page);

        setPage(PAGES[page.replaceAll('-', '_')] || defaultPage);
    }
}

function setPage(page) {
    if (currentPage.pageName != null) {
        currentPage.hide();
        if (Modal.currentModal && Modal.currentModal.dismiss) {
            Modal.currentModal.hide(false);
        }
    }
    
    currentPage = page;
    if (currentPage.requireTest) {
        loadPageRequiringTest();
    } else {
        currentPage.onload?.();
    }
}

/* load a page that require a test */
function loadPageRequiringTest(update = false) {
    var testId = Number(currentURL.searchParams.get('test'));
    if (testId) {
        if (testId != currentTest?.id) {
            var request = DATABASE_MANAGER.getFullTest(testId);
            request.onsuccess = function(test) {
                currentTest = test;
                currentPage.onload?.();
            };
            request.onerror = function(event) {
                backToMain();
            };
        } else {
            if (update) {
                currentPage.onupdate?.();
            } else {
                currentPage.onload?.();
            }
        }
    } else {
        backToMain();
    }
}

/* return to the list if an error occur for example */
function backToMain(newState = false) {
    if (newState) {
        window.history.pushState({}, 'Main page', MAIN_URL);
    } else {
        window.history.replaceState({}, 'Main page', MAIN_URL);
    }
    loadPage();
}

addEventListener("keydown", function(event) {
    currentPage.onkeydown?.(event);
}, {capture: true});

addEventListener("keydown", function(event) {
    if (event.keyCode === KeyboardEvent.DOM_VK_ESCAPE) {
        if (Modal.currentModal) {
            if (!Modal.currentModal.noDismiss) Modal.hideModal();
        } else if (currentPage !== defaultPage) {
            backToMain(true);
        }
    }
});

addEventListener("click", function(event) {
    currentPage.onclick?.(event);
}, {capture: true});

addEventListener("visibilitychange", function(event) {
    currentPage.onvisibilitychange?.(event);
}, {capture: true});

addEventListener("beforeunload", function(event) {
    currentPage.ondelete?.(); // make sure that the state is correctly
}, {capture: true});

var initNavigationFunc = initNavigation();

/* ####################### res/js/pages/index/callbacks.js ########################*/

document.getElementById('nav-logo').onclick = () => backToMain(true);


/* ######################### res/js/pages/index/utils.js ##########################*/

const importTestModal = new Modal(document.getElementById('import-test-modal'));
const importModalInput = document.getElementById('import-test-input');
const importModalSelect = document.getElementById('import-test-select');
const importModalCsv = document.getElementById('import-csv');
const importModalCsvColumnName = document.getElementById('import-csv-column-name');
const importModalCsvColumnType = document.getElementById('import-csv-column-type');

const exportModal = new Modal(document.getElementById('export-test-modal'));
const exportModalSelect = document.getElementById('export-test-select');
const exportModalCsv = document.getElementById('export-csv');
const exportModalCsvColumnName = document.getElementById('export-csv-column-name');
const exportModalCsvColumnType = document.getElementById('export-csv-column-type');

class Utils {
    constructor() {

        document.getElementById('import-form').onsubmit = this.importTestCallback.bind(this);
        importModalInput.onchange = this.importFileChange.bind(this);
        importModalSelect.onchange = this.importSelectChange.bind(this);

        document.getElementById('export-form').onsubmit = this.exportTestConfirm.bind(this);
        exportModalSelect.onchange = this.exportWarningCsv.bind(this);
        exportModal.onhide = () => this.data = null;
    }
    /* redirect to the view page of a test */
    viewTestPage(id) {
        currentURL.searchParams.set('page', 'view');
        currentURL.searchParams.set('test', id || currentTest.id);
        window.history.pushState({}, 'View page', currentURL);
        loadPage();
    }

    /* redirect to add a test */
    addTestRedirect() {
        currentURL.searchParams.set('page', 'edit');
        currentURL.searchParams.set('test', 'new');
        window.history.pushState({}, 'Edit page', currentURL);
        loadPage();
    }

    /* open the play page if id not set keep the same test index of the current url */
    playTestPage(id) {
        this.requiredPlayable(id || currentTest.id).then(playable => {
            if (playable) {
                currentURL.searchParams.set('page', 'play-card');
                if (id) currentURL.searchParams.set('test', id);
                history.pushState({}, 'Play card', currentURL);
                loadPage();
            }
        });
    }

    /* open the eval page if id not set keep the same test index of the current url */
    evalTestPage(id) {
        this.requiredPlayable(id || currentTest.id).then(playable => {
            if (playable) {
                currentURL.searchParams.set('page', 'eval-settings');
                if (id) currentURL.searchParams.set('test', id);
                history.pushState({}, 'Eval settings', currentURL);
                loadPage();
            }
        });
    }

    /* test if a test is playable if no, show a modal */
    async requiredPlayable(id) {
        if (await DATABASE_MANAGER.getPlayable(id)) {
            return true;
        } else {
            if (await Modal.showActionModal(
                'error-playable-title',
                'error-playable-message', 
                {name: 'edit', icon: '/WebDiakoluo/res/img/edit_w.svg'}
            )) {
                this.editTestPage(id);
            }
            return false;
        }
    }

    /* open the edit page if id not set keep the same test index of the current url */
    editTestPage(id) {
        currentURL.searchParams.set('page', 'edit');
        if (id) currentURL.searchParams.set('test', id);
        history.pushState({}, 'Edit test', currentURL);
        loadPage();
    }

    /* delete the test */
    deleteTest(id) {
        Modal.showActionModal(
            'delete-test-title', 
            'delete-test-message', 
            {name: 'delete', icon: '/WebDiakoluo/res/img/delete_w.svg'},
            {important: true})
        .then(response => {
            if (response) {
                DATABASE_MANAGER.deleteTest(id || currentTest.id);
                currentTest = null; // TODO cancel button
                defaultPage.needReload = true;
                backToMain(true);
            }
        });      
    }

    /* export a test */
    exportTest(id) {
        if (id && id !== currentTest?.id) {
            var request = DATABASE_MANAGER.getFullTest(id);
            request.onsuccess = test => {
                this.data = test;
                this.loadExportModal();
            };
        } else if (currentTest) {
            this.data = currentTest;
            this.loadExportModal();
        }
    }

    /* load export modal */
    loadExportModal() {
        exportModal.show();
        this.exportWarningCsv();
    }

    /* callback to show the warning */
    exportWarningCsv() {
        if (exportModalSelect.value == 'csv') {
            exportModalCsv.classList.remove('hide');
        } else {
            exportModalCsv.classList.add('hide');
        }
    }

    /* confirm the export */
    exportTestConfirm(event) {
        event.preventDefault();
        
        if (exportModalSelect.value == 'dkl') {
            FILE_MANAGER.exportTest(this.data);
        } else {
            FILE_MANAGER.exportCsvTest(this.data, exportModalCsvColumnName.checked, exportModalCsvColumnType.checked);
        }
        exportModal.hide();
        this.data = null;
    }

    /* export all tests */
    exportAllTest() {
        FILE_MANAGER.exportAllTest().catch(
            () => Modal.showOkModal('error-export-all-title', 'error-export-all-message', {important: true})
        );
    }

    /* duplicate the test */
    duplicateTest(id) {
        if (id && id !== currentTest?.id) {
            var request = DATABASE_MANAGER.getFullTest(id);
            request.onsuccess = test => {
                this.doDuplicateTest(test);
            };
        } else if (currentTest) {
            this.doDuplicateTest(currentTest);
        }
    }

    /* do the duplication of test, see #duplicateTest */
    doDuplicateTest(test) {
        this.data = test.title;
        test.title = test.title + I18N.getTranslation('duplicate-suffix');
        DATABASE_MANAGER.addNewTest(test).onsuccess = () => {
            defaultPage.reloadList();
            test.title = this.data;
        }
    }

    /* import a test */
    importTest() {
        importTestModal.show();
        this.importFileChange();
        this.importSelectChange();
    }

    /* the import test callback */
    importTestCallback(event) {
        event.preventDefault();
        importTestModal.hide();

        for (var i = 0; i < importModalInput.files.length; i++) {
            FILE_MANAGER.importTest(
                importModalInput.files[i], 
                importModalSelect.value == 'dkl', 
                importModalCsvColumnName.checked, 
                importModalCsvColumnType.checked
            )
            .then(() => defaultPage.reloadList())
            .catch(() => Modal.showOkModal('error-import-title', 'error-import-message', {important: true}));
        }
    }

    /* when a file is inputted */
    importFileChange() {
        if (importModalInput.files.length > 0) {
            FILE_MANAGER.getTypeFile(importModalInput.files[0]).then(
                (formatFile) => {
                    importModalSelect.value = formatFile ? 'dkl' : 'csv'
                    this.importSelectChange();
                }
            );
            
        }
    }

    /* when the select change */
    importSelectChange() {
        if (importModalSelect.value === 'dkl') {
            importModalCsv.classList.add('hide');
        } else {
            importModalCsv.classList.remove('hide');
        }
    }

    settings() {
        currentURL.searchParams.set('page', 'settings');
        history.pushState({}, 'Settings', currentURL);
        loadPage();
    }
}

const UTILS = new Utils();

/* ######################## res/js/pages/index/settings.js ########################*/

const settingsPageView = document.getElementById('settings-page');
const settingsPagePanels = {
    general: {
        view: document.getElementById('settings-panel-general'), 
        button: document.getElementById('settings-nav-general')
    },
    appearance: {
        view: document.getElementById('settings-panel-appearance'), 
        button: document.getElementById('settings-nav-appearance')
    },
    sync: {
        view: document.getElementById('settings-panel-sync'), 
        button: document.getElementById('settings-nav-sync')
    }
}

const settingsPageVersion = document.getElementById('settings-version');
const settingsPageVerifyUpdate = document.getElementById('settings-get-version');
const settingsPageLastUpdatePanel =  document.getElementById('settings-verify-update-panel');
const settingsPageLastUpdate =  document.getElementById('settings-last-update');
const settingsPageUpdate = document.getElementById('settings-update');
const settingsPageUpdateStatus = document.getElementById('settings-update-status');

const settingsPageThemeLightLabel = document.getElementById('settings-theme-light-label');
const settingsPageThemeLight = document.getElementById('settings-theme-light');
const settingsPageThemeAutoLabel = document.getElementById('settings-theme-auto-label');
const settingsPageThemeAuto = document.getElementById('settings-theme-auto');
const settingsPageThemeDarkLabel = document.getElementById('settings-theme-dark-label');
const settingsPageThemeDark = document.getElementById('settings-theme-dark');

const settingsPageSyncForm = document.getElementById('settings-sync-form');
const settingsPageSyncHost = document.getElementById('settings-sync-host');
const settingsPageSyncUsername = document.getElementById('settings-sync-username');
const settingsPageSyncPassword = document.getElementById('settings-sync-password');
const settingsPageStatusText = document.getElementById('settings-sync-status');

/**
 * The settings page
 */
class SettingsPage extends Page {
    /**
     * Create a new settings page.
     */
    constructor() {
        super(settingsPageView, 'settings', false);

        this.activePanel = null;

        const keys = Object.keys(settingsPagePanels);
        for (let i = 0; i < keys.length; i++) {
            const panelName = keys[i];
            settingsPagePanels[panelName].button.onclick = () => this.onNavButtonClick(panelName);
        }
        settingsPagePanels.sync.callback = this.onSyncPanel.bind(this);

        I18N.initAsyncFunc.then(() => settingsPageVersion.textContent = I18N.getTranslation('version') + ' (' + I18N.getTranslation('id') + ')');
        settingsPageVerifyUpdate.onclick = this.verifyUpdate.bind(this);
        settingsPageUpdate.onclick = this.updateButton.bind(this);

        settingsPageThemeLight.onchange = () => this.setThemeRadio('light');
        settingsPageThemeAuto.onchange = () => this.setThemeRadio('auto');
        settingsPageThemeDark.onchange = () => this.setThemeRadio('dark');
        this.setThemeRadio();

        settingsPageSyncForm.onsubmit = this.onSyncSubmit.bind(this);
    }

    /**
     * When the page is loaded
     */
    onload() {
        super.onload();
        this.onupdate();
    }

    /**
     * When the page is updated
     */
    onupdate() {
        const panel = currentURL.searchParams.get('panel') || 'general';
        const selectedPanel = settingsPagePanels[panel] || settingsPagePanels['general'];
        if (this.activePanel !== this.selectedPanel) {
            if (this.activePanel) {
                this.activePanel.view.classList.add('hide');
                this.activePanel.button.classList.remove('active');
            }
    
            this.activePanel = selectedPanel;
            this.activePanel.view.classList.remove('hide');
            this.activePanel.button.classList.add('active');  

            selectedPanel.callback?.();
        }
    }

    /**
     * Set the theme or update if no theme is passed.
     * @param {string} [theme] The theme to set
     */
    setThemeRadio(theme) {
        var selected = getSelectedTheme();
        if (selected !== theme) {
            if (theme) {
                setSelectedTheme(theme);
                switch (selected) {
                    case 'light':
                        settingsPageThemeLightLabel.classList.remove('selected');
                        settingsPageThemeLight.checked = false;
                        break;
        
                    case 'auto':
                        settingsPageThemeAutoLabel.classList.remove('selected');
                        settingsPageThemeAuto.checked = false;
                        break;
        
                    case 'dark':
                        settingsPageThemeDarkLabel.classList.remove('selected');
                        settingsPageThemeDark.checked = false;
                        break;
                }
            } else {
                theme = selected;
            }
            switch (theme) {
                case 'light':
                    settingsPageThemeLightLabel.classList.add('selected');
                    settingsPageThemeLight.checked = true;
                    break;
    
                case 'auto':
                    settingsPageThemeAutoLabel.classList.add('selected');
                    settingsPageThemeAuto.checked = true;
                    break;
    
                case 'dark':
                    settingsPageThemeDarkLabel.classList.add('selected');
                    settingsPageThemeDark.checked = true;
                    break;
            }
        }
    }

    /**
     * When a nav button is clicked.
     * @param {string} panelName The name of the panel to go
     */
    onNavButtonClick(panelName) {
        currentURL.searchParams.set('panel', panelName);
        history.pushState({}, '', currentURL);
        this.onupdate();
    }

    /**
     * When the sync panel is loaded.
     */
    onSyncPanel() {
        settingsPageSyncHost.value = SyncManager.syncManager ? SyncManager.syncManager.host + '/' : "";
        settingsPageSyncUsername.value = SyncManager.syncManager?.username || "";
        settingsPageSyncPassword.value = SyncManager.syncManager?.password || "";
        settingsPageStatusText.setAttribute("key", "");
        settingsPageStatusText.textContent = "";
    }

    /**
     * When the sync form is submitted.
     * @param {*} event the event of the submit
     */
    async onSyncSubmit(event) {
        event.preventDefault();
        var host = settingsPageSyncHost.value;
        var username = settingsPageSyncUsername.value;
        var password = settingsPageSyncPassword.value;

        if (!host.startsWith('http')) {
            host = "http://" + host;
        }
        try {
            var url = new URL(host);
            if (url.protocol !== "http:" && url.protocol !== "https:") throw TypeError();
            host = url.toString();
            if (host.endsWith('/')) {
                host = host.substring(0, host.length - 1)
            }
        } catch {
            settingsPageSyncHost.focus();
        }
        
        try {
            await SyncManager.syncManager?.authFetch('/logout');
        } catch {}
        
        var s = new SyncManager({username: username, password: password, host: host});
        settingsPageStatusText.setAttribute('key', 'settings-sync-loading');
        settingsPageStatusText.classList.remove('important-font');
        s.authFetch('/test').then((test) => {
            SyncManager.setSyncAccount(s);
            this.onSyncPanel();
            settingsPageStatusText.setAttribute('key', 'settings-sync-success');
        })
        .catch((error) => {
            if (error.error) {
                settingsPageStatusText.setAttribute('key', 'settings-sync-error');
            } else {
                settingsPageStatusText.setAttribute('key', 'settings-sync-login-failed');
            }
            settingsPageStatusText.classList.add('important-font');
        });
    }

    /**
     * Verify if there is an update and update the UI (callback of settingsVerifyUpdate)
     */
    async verifyUpdate() {
        try {
            var r = await fetch('/WebDiakoluo/api/last_cache_id.json');
            r = await r.json();
            settingsPageLastUpdatePanel.classList.remove('hide');
            settingsPageLastUpdate.textContent = `${r.version} (${r.id})`
            if (I18N.getTranslation('id') !== r.id) {
                settingsPageLastUpdate.classList.add('important-font')
            } else {
                settingsPageLastUpdate.classList.remove('important-font')
            }
        } catch {
            settingsPageLastUpdatePanel.classList.remove('hide');
            settingsPageLastUpdate.textContent = I18N.getTranslation('no-connection');
            settingsPageLastUpdate.classList.add('important-font')
        }
    }

    /**
     * Update the button
     */
    async updateButton() {
        settingsPageUpdateStatus.classList.remove('important-font');
        settingsPageUpdateStatus.textContent = I18N.getTranslation('settings-updating');
        try {
            if (serviceWorkerRegistration.update) {
                await serviceWorkerRegistration.update();
            } else {
                await serviceWorkerRegistration.unregister();
            }
            settingsPageUpdateStatus.textContent = I18N.getTranslation('settings-updated');
            setTimeout(() => document.location = document.location, 3000);
        } catch (e) {
            console.error("[Service Worker] Can't update", e);
            settingsPageUpdateStatus.classList.add('important-font')
            settingsPageUpdateStatus.textContent = I18N.getTranslation('settings-cant-update');
        }
    }
}

PAGES.settings = new SettingsPage();


/* ########################## res/js/pages/index/list.js ##########################*/

const listPageView = document.getElementById('list-page');
const listPageTestList = document.getElementById('list-test');

const testListTemplate = document.getElementById('list-test-child-template');
const testListSyncTemplate = document.getElementById('list-test-sync');

document.getElementById('list-add-button').onclick = UTILS.addTestRedirect;

class ListPage extends Page {
    constructor() {
        super(listPageView, '', false);

        document.getElementById('list-import-button').onclick = () => UTILS.importTest();
        document.getElementById('list-export-all-button').onclick = () => UTILS.exportAllTest();

        this.contextMenu = new ContextMenu('list-page-context-menu');
        document.getElementById('list-test-play-button').onclick = () => UTILS.playTestPage(this.contextMenu.dataIndex);
        document.getElementById('list-test-eval-button').onclick = () => UTILS.evalTestPage(this.contextMenu.dataIndex);
        document.getElementById('list-test-edit-button').onclick = () => UTILS.editTestPage(this.contextMenu.dataIndex);
        document.getElementById('list-test-duplicate-button').onclick = () => UTILS.duplicateTest(this.contextMenu.dataIndex);
        document.getElementById('list-test-export-button').onclick = () => UTILS.exportTest(this.contextMenu.dataIndex);
        document.getElementById('list-test-delete-button').onclick = () => UTILS.deleteTest(this.contextMenu.dataIndex);

        this.needReload = true;
    }

    /* load list page */
    onload() {
        I18N.updatePageTitle('title-index');
        listPageView.classList.remove('hide');
        if (this.needReload) this.reloadList();
    }

    onkeydown(event) {
        if (event.keyCode == KeyboardEvent.DOM_VK_ESCAPE) {
            if (this.contextMenu.disimiss()) {
                event.stopPropagation();               
            }
        }
    }

    /* when a context menu is used on a test */
    oncontextmenu(event, index, playable) {
        event.preventDefault();
        this.contextMenu.show(event.pageX, event.pageY);
        this.contextMenu.dataIndex = index;
        this.contextMenu.dataPlayable = playable;
    }

    /* when the page is clicked */
    onclick(event) {
        if (this.contextMenu.disimiss()) {
            event.preventDefault();
            document.activeElement.blur();
        }
    }

    /* reload the test list */
    reloadList() {
        this.needReload = false;
        removeAllChildren(listPageTestList);
        DATABASE_MANAGER.forEachHeader().onsuccess = event => {
            var cursor = event.target.result;
            if (cursor) {
                var t = testListTemplate.content.cloneNode(true);
                var v = cursor.value;
                var id = cursor.value.id;
                var playable = cursor.value.playable;
                if (id == EDIT_KEY) {
                    t.querySelector('.test-title-span').textContent = I18N.getTranslation("edited-test");
                    t.querySelector('.test-description').textContent = v.title;
                    t.children[0].onclick = function() {
                        UTILS.editTestPage('current');
                    }
                    listPageTestList.insertBefore(t, listPageTestList.firstChild); // insert at first
                } else {
                    var titleSpan = t.querySelector('.test-title-span');
                    if (v.sync) {
                        var sync = testListSyncTemplate.content.cloneNode(true);
                        t.querySelector('.test-title').insertBefore(sync, titleSpan);
                    }
                    titleSpan.textContent = v.title;
                    t.querySelector('.test-description').textContent = v.description;
                    t.children[0].onclick = function() {
                        UTILS.viewTestPage(id);
                    }
                    t.children[0].onkeydown = onReturnClick;
                    t.children[0].oncontextmenu = e => this.oncontextmenu(e, id, playable);
                    listPageTestList.appendChild(t);
                    cursor.continue();
                }
            }
        };
    }
}

const defaultPage = new ListPage();

/* ########################## res/js/pages/index/view.js ##########################*/

const viewPageView = document.getElementById('view-page');

const viewPageTitle = [document.getElementById('view-test-title'), document.getElementById('view-test-title2')];
const viewPageTitleSync = document.getElementById('view-test-title-sync');
const viewPageDescription = document.getElementById('view-test-description');
const viewPageCreatedDate = document.getElementById('view-test-created-date');
const viewPageModificationDate = document.getElementById('view-test-modification-date');
const viewPageColumnsList = document.getElementById('view-test-columns');
const viewPageDataTableHeader = document.getElementById('view-test-data-header');
const viewPageDataTableBody = document.getElementById('view-test-data-body');

const viewColumnModal = new Modal(document.getElementById('view-test-column-modal'));
const viewColumnModalTitle1 = document.getElementById('modal-view-column-title1');
const viewColumnModalTitle2 = document.getElementById('modal-view-column-title2');
const viewColumnModalDescription = document.getElementById('modal-view-column-description');
const viewColumnModalSettings = document.getElementById('modal-view-column-settings');

const viewSyncDiv = document.getElementById('view-sync');
const viewSyncId = document.getElementById('view-sync-test-id');
const viewSyncPerms = document.getElementById('view-sync-test-perms');
const viewSyncOwner = document.getElementById('view-sync-test-owner');

const viewDataModal = new Modal(document.getElementById('view-test-data-modal'));
const viewDataModalContent = document.getElementById('view-test-data-content');
const viewDataModalId = document.getElementById('view-test-data-id');

const viewColumnTemplate = document.getElementById('view-column-child-template');
const viewDataTemplate = document.getElementById('view-data-child-template');

class ViewPage extends Page {
    constructor() {
        super(viewPageView, "view", true);

        document.getElementById('view-play-button').onclick = () => UTILS.playTestPage();
        document.getElementById('view-eval-button').onclick = () => UTILS.evalTestPage();
        document.getElementById('view-edit-button').onclick = () => UTILS.editTestPage();
        document.getElementById('view-export-button').onclick = () => UTILS.exportTest();
        document.getElementById('view-delete-button').onclick = () => UTILS.deleteTest();

        this.columnsModalNav = new NavigationBar(document.getElementById('view-column-nav-bar'), [
            {className: "nav-edit", onclick: () => UTILS.editTestPage()}
        ]);
        this.columnsModalNav.onfirst = this.firstColumn.bind(this); 
        this.columnsModalNav.onprevious = this.previousColumn.bind(this); 
        this.columnsModalNav.onnext = this.nextColumn.bind(this); 
        this.columnsModalNav.onlast = this.lastColumn.bind(this); 

        this.dataModalNav = new NavigationBar(document.getElementById('view-data-nav-bar'), [
            {className: "nav-edit", onclick: () => UTILS.editTestPage()}
        ]);
        this.dataModalNav.onfirst = this.firstData.bind(this); 
        this.dataModalNav.onprevious = this.previousData.bind(this); 
        this.dataModalNav.onnext = this.nextData.bind(this); 
        this.dataModalNav.onlast = this.lastData.bind(this); 
    }

    /* when the page is loaded */
    onload() {
        for (var i = 0; i < viewPageTitle.length; i++) {
            viewPageTitle[i].textContent = currentTest.title;
        }
        if (currentTest.sync) {
            viewPageTitleSync.classList.remove('hide');
            viewSyncDiv.classList.remove('hide');
            const loading = I18N.getTranslation('loading');
            viewSyncId.textContent = loading;
            viewSyncPerms.textContent = loading;
            viewSyncOwner.textContent = loading;

            SyncManager.syncManager.getTestInfo(currentTest).then(data => {
                viewSyncId.textContent = data.serverTestId;
                viewSyncPerms.textContent = I18N.getTranslation('perm-' + data.share);
                viewSyncOwner.textContent =`${data.owner.name} (${data.owner.username})`
            });
        } else {
            viewPageTitleSync.classList.add('hide');
            viewSyncDiv.classList.add('hide');
        }
        
        viewPageDescription.textContent = currentTest.description;
        viewPageCreatedDate.textContent = DATE_FORMATTER.format(currentTest.createDate);
        viewPageModificationDate.textContent = DATE_FORMATTER.format(currentTest.lastModificationDate);

        removeAllChildren(viewPageColumnsList);
        removeAllChildren(viewPageDataTableHeader);
        removeAllChildren(viewPageDataTableBody);
        var e;
        var row = viewDataTemplate.content.cloneNode(true);
        row.querySelector('.min').innerHTML = '<x-i18n key="view"></x-i18n>';
        for (let i = 0; i < currentTest.columns.length; i++) {
            e = viewColumnTemplate.content.cloneNode(true);
            e.querySelector('.test-column-text').textContent = currentTest.columns[i].name;
            e.children[0].onclick = () => {
                this.columnClickCallback(i);
            };
            e.children[0].onkeydown = onReturnClick;

            viewPageColumnsList.appendChild(e);

            e = document.createElement('td');
            e.textContent = currentTest.columns[i].name;
            row.children[0].appendChild(e);
        }
        viewPageDataTableHeader.appendChild(row);

        for (let i = 0; i < currentTest.data.length; i++) {
            row = viewDataTemplate.content.cloneNode(true);
            for (var j = 0; j < currentTest.data[i].length; j++) {
                e = document.createElement('td');
                e.appendChild(currentTest.columns[j].getViewView(currentTest.data[i][j]));
                row.children[0].appendChild(e);
            }
            row.children[0].onclick = () => {
                this.dataClickCallback(i);
            }
            row.children[0].onkeydown = onReturnClick;
            viewPageDataTableBody.appendChild(row);
        }

        viewColumnModal.id = -1;
        viewDataModal.id = -1;
        I18N.setPageTitle(currentTest.title);
        viewPageView.classList.remove('hide');
        this.updateModals(true);
    }

    /* when the page is updated */
    onupdate() {
        this.updateModals(false);
    }

    updateModals(addHistory) {
        var p = Number(currentURL.searchParams.get('column'));
        if (p) {
            if (p > currentTest.columns.length) p = currentTest.data.length;
            if (p <= 0) p = 1;
            if (addHistory) {
                var url = new URL(currentURL);
                url.searchParams.delete('column');
                history.replaceState({}, '', url);
            }
            this.updateColumnModal(p - 1, addHistory);
            return;
        }

        p = Number(currentURL.searchParams.get('data'));
        if (p) {
            if (p > currentTest.data.length) p = currentTest.data.length;
            if (p <= 0) p = 1;
            if (addHistory) {
                var url = new URL(currentURL);
                url.searchParams.delete('data');
                history.replaceState({}, '', url);
            }
            this.updateDataModal(p - 1, addHistory);
            return;
        }
    }

    /* when a key is press */
    onkeydown(event) {
        switch (event.keyCode) {
            case KeyboardEvent.DOM_VK_RIGHT:
                if (Modal.currentModal === viewColumnModal) {
                    this.nextColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == viewDataModal) {
                    this.nextData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_LEFT:
                if (Modal.currentModal === viewColumnModal) {
                    this.previousColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == viewDataModal) {
                    this.previousData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_PAGE_DOWN:
                if (Modal.currentModal === viewColumnModal) {
                    this.lastColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == viewDataModal) {
                    this.lastData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_PAGE_UP:
                if (Modal.currentModal === viewColumnModal) {
                    this.firstColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == viewDataModal) {
                    this.firstData();
                    event.preventDefault();
                }
                break;
        }

        if (event.altKey) {
            switch (event.keyCode) {
                case KeyboardEvent.DOM_VK_S:
                    event.preventDefault();
                    UTILS.playTestPage();
                    break;

                case KeyboardEvent.DOM_VK_G:
                    event.preventDefault();
                    UTILS.evalTestPage();
                    break;

                case KeyboardEvent.DOM_VK_E:
                    event.preventDefault();
                    UTILS.editTestPage();
                    break;
            }
        }
    }

    /* update the column modal */
    updateColumnModal(id, addHistory=true) {
        if (Modal.currentModal !== viewColumnModal) {
            viewColumnModal.show(true, addHistory);
        }
        if (viewColumnModal.id != id) {
            viewColumnModal.id = id;
            this.columnsModalNav.updateStatus(id <= 0, id >= currentTest.columns.length - 1);
            
            var column = currentTest.columns[id];
            viewColumnModalTitle1.textContent = column.name;
            viewColumnModalTitle2.textContent = column.name;
            viewColumnModalDescription.textContent = column.description;
            viewColumnModalSettings.replaceChild(
                column.getViewColumnSettings(),
                viewColumnModalSettings.children[0]
            );
        }
    }

    /* update the data modal */
    updateDataModal(id, addHistory=true) {
        if (Modal.currentModal !== viewDataModal) {
            viewDataModal.show(true, addHistory);
        }
        if (viewDataModal.id != id) {
            viewDataModal.id = id;
            this.dataModalNav.updateStatus(id <= 0, id >= currentTest.data.length - 1);

            var row = currentTest.data[id];
            viewDataModalId.textContent = id + 1;
            removeAllChildren(viewDataModalContent);
            var e;
            var column;
            for (var i = 0; i < row.length; i++) {
                column = currentTest.columns[i];
                e = document.createElement('h3');
                e.textContent = column.name + ":";
                e.classList = ['no-margin']
                viewDataModalContent.appendChild(e);

                viewDataModalContent.appendChild(column.getViewView(row[i]));
            }
        }
    }

    /* when a column is clicked */
    columnClickCallback(id) {
        currentURL.searchParams.set('column', id + 1);
        this.updateColumnModal(id);
    }

    /* go to the next column */
    nextColumn() {
        if (viewColumnModal.id < currentTest.columns.length - 1) {
            this.updateColumnModal(viewColumnModal.id + 1); // don't add to history in order to not spam the history 
        }
    }

    /* go to the previous column */
    previousColumn() {
        if (viewColumnModal.id > 0) {
            this.updateColumnModal(viewColumnModal.id - 1);
        }
    }

    /* go to the first column */
    firstColumn() {
        this.updateColumnModal(0);
    }

    /* go to the last column */
    lastColumn() {
        this.updateColumnModal(currentTest.columns.length - 1);
    }

    /* when a data is clicked */
    dataClickCallback(id) {
        currentURL.searchParams.set('data', id + 1);
        this.updateDataModal(id);
    }

    /* go to the next data */
    nextData() {
        if (viewDataModal.id < currentTest.data.length - 1) {
            this.updateDataModal(viewDataModal.id + 1);
        }
    }

    /* go to the previous data */
    previousData() {
        if (viewDataModal.id > 0) {
            this.updateDataModal(viewDataModal.id - 1);
        }
    }

    /* go to the first data */
    firstData() {
        this.updateDataModal(0);
    }

    /* go to the last data */
    lastData() {
        this.updateDataModal(currentTest.data.length - 1);
    }
}

PAGES.view = new ViewPage();


/* ########################## res/js/pages/index/edit.js ##########################*/

const EDIT_AUTO_SAVE_TIME = 10 * 1000;

const editPageView = document.getElementById('edit-page');
const editPageTitle = document.getElementById('edit-test-title');
const editPageDescription = document.getElementById('edit-test-description');
const editPageColumnsList = document.getElementById('edit-test-columns');
const editPageDataTableHeader = document.getElementById('edit-test-data-header');
const editPageDataTableBody = document.getElementById('edit-test-data-body');

const editColumnModalTitle1 = document.getElementById('modal-edit-column-title1');
const editColumnModalTitle2 = document.getElementById('modal-edit-column-title2');
editColumnModalTitle2.onkeyup = () => {editColumnModalTitle1.textContent = editColumnModalTitle2.value};
const editColumnModalDescription = document.getElementById('modal-edit-column-description');
const editColumnModalSettings = document.getElementById('modal-edit-column-settings')

const editDataModalContent = document.getElementById('edit-test-data-content');
const editDataModalId = document.getElementById('edit-test-data-id');

const editColumnTemplate = document.getElementById('edit-column-child-template');
const editDataTemplate = document.getElementById('edit-data-child-template');

const editColumnModal = new Modal(document.getElementById('edit-test-column-modal'));
const editDataModal = new Modal(document.getElementById('edit-test-data-modal'));

class EditPage extends Page {
    constructor() {
        super(editPageView, 'edit', false);
        this.autoSaveId = null;

        document.getElementById('edit-add-column-button').onclick = this.addColumn.bind(this);
        document.getElementById('edit-add-data-button').onclick = this.addData.bind(this);
        document.getElementById('edit-save-button').onclick = this.saveButton.bind(this);
        document.getElementById('edit-cancel-button').onclick = this.cancelButton.bind(this);

        this.columnsModalNav = new NavigationBar(document.getElementById('edit-column-nav-bar'), [
            {className: "nav-delete", onclick: this.removeColumnModal.bind(this)}, 
            {className: "nav-add", onclick: this.addColumn.bind(this)}
        ]);
        this.columnsModalNav.onfirst = this.firstColumn.bind(this); 
        this.columnsModalNav.onprevious = this.previousColumn.bind(this); 
        this.columnsModalNav.onnext = this.nextColumn.bind(this); 
        this.columnsModalNav.onlast = this.lastColumn.bind(this); 

        this.dataModalNav = new NavigationBar(document.getElementById('edit-data-nav-bar'), [
            {className: "nav-delete", onclick: this.removeDataModal.bind(this)}, 
            {className: "nav-add", onclick: this.addData.bind(this)}
        ]);
        this.dataModalNav.onfirst = this.firstData.bind(this); 
        this.dataModalNav.onprevious = this.previousData.bind(this); 
        this.dataModalNav.onnext = this.nextData.bind(this); 
        this.dataModalNav.onlast = this.lastData.bind(this); 

        editColumnModal.onhide = this.closeColumnModal.bind(this);
        editDataModal.onhide = this.closeDataModal.bind(this);
    }

    /* When the page is loaded */
    onload() {
        var testId = currentURL.searchParams.get('test');
        if (testId == "new") {
            if (currentTest?.id != EDIT_KEY) {
                var request = DATABASE_MANAGER.getFullTest(EDIT_KEY);
                request.onsuccess = test => {
                    currentTest = test;
                    if (test.edit_id) {
                        this.initialiseNewTest();
                    } else {
                        this.loadTest();
                    }
                }

                request.onerror = this.initialiseNewTest.bind(this);
            } else if (currentTest.edit_id) {
                this.initialiseNewTest();
            } else {
                this.loadTest();
            }
        } else if (testId == "current") {
            if (currentTest?.id === EDIT_KEY) {
                this.loadTest();
            } else {
                var request = DATABASE_MANAGER.getFullTest(EDIT_KEY);
                request.onsuccess = test => {
                    currentTest = test;
                    this.loadTest();
                }
                request.onerror = backToMain;
            }
        } else {
            testId = Number(testId);
            if (testId) {
                if (currentTest?.id === EDIT_KEY) {
                    if (currentTest.edit_id == testId) {
                        this.loadTest();
                    } else {
                        this.initialiseTest(testId);
                    }
                } else {
                    var request = DATABASE_MANAGER.getFullTest(EDIT_KEY);
                    request.onsuccess = test => {
                        currentTest = test;
                        if (testId === test.edit_id) {
                            this.loadTest();
                        } else {
                            this.initialiseTest(testId);
                        }
                    }
                    request.onerror = () => this.initialiseTest(testId);
                }
            } else {
                backToMain();
            }
        }
    }

    /* When the page is updated */
    onupdate() {
        if (currentTest?.id == EDIT_KEY) {
            var testId = currentURL.searchParams.get('test');
            if (testId == "new") {
                if (testId.edit_id) {
                    this.ondelete();
                    this.onload();
                    return;
                }
            } else if (testId != "current") {
                testId = Number(testId);
                if (testId != currentTest.edit_id) {
                    this.ondelete();
                    this.onload();
                    return;
                }
            }
        } else {
            this.ondelete();
            this.onload();
            return;
        }
        this.updateModal(false);
    }

    /* verify if the url show any modal */
    updateModal(addHistory) {
        var p = Number(currentURL.searchParams.get('column'));
        if (p) {
            if (p > currentTest.columns.length) p = currentTest.data.length;
            if (p <= 0) p = 1;
            if (addHistory) {
                var url = new URL(currentURL);
                url.searchParams.delete('column');
                history.replaceState({}, '', url);
            }
            this.updateColumnModal(p - 1, addHistory);
            return;
        }

        p = Number(currentURL.searchParams.get('data'));
        if (p) {
            if (p > currentTest.data.length) p = currentTest.data.length;
            if (p <= 0) p = 1;
            if (addHistory) {
                var url = new URL(currentURL);
                url.searchParams.delete('data');
                history.replaceState({}, '', url);
            }
            this.updateDataModal(p - 1, addHistory);
            return;
        }
    }


    /* when the page is deleted */
    ondelete() {
        if (currentTest?.id == EDIT_KEY) this.saveTest(); // save only if it's a edit test
        clearInterval(this.pageAutoSaveId);
        this.pageAutoSaveId = null;
    }

    /* create a new edit test from a test already existing */
    async initialiseTest(id) {
        if (currentTest?.id !== EDIT_KEY || await this.showEraseWarning(id)) { // alert the user if we erase a currently edit test
            var request = DATABASE_MANAGER.getFullTest(id);
            request.onsuccess = test => {
                currentTest = test;
                currentTest.edit_id = id;
                currentTest.id = EDIT_KEY;
                this.loadTest();
            }

            request.onerror = backToMain;
        }
    }

    /* initialise a new test */
    async initialiseNewTest() {
        if (currentTest?.id !== EDIT_KEY || await this.showEraseWarning()) {
            currentTest = new Test(I18N.getTranslation("default-test-title"), I18N.getTranslation("default-test-description"));
            currentTest.id = EDIT_KEY;
            this.loadTest();
        }
    }

    async showEraseWarning(id) {
        if (id != null && !await DATABASE_MANAGER.testExist(id)) {
            backToMain(false);
            return false;
        }
        this.loadTest();
        var r = await Modal.showActionModal(
            'warning-erase-title', 
            'warning-erase-message',
            {name: 'erase'}
        );
        if (!r) {
            currentURL.searchParams.set('test', 'current');
            history.replaceState({}, '', currentURL);
        }
        return r;
    }

    /* load the current test in the UI */
    loadTest() {
        editPageTitle.value = currentTest.title;
        editPageDescription.value = currentTest.description;

        removeAllChildren(editPageColumnsList);
        removeAllChildren(editPageDataTableHeader);
        removeAllChildren(editPageDataTableBody);

        this.onvisibilitychange(); // set auto save automatic

        var row = editDataTemplate.content.cloneNode(true);
        row.querySelector('.min').innerHTML = '<x-i18n key="edit"></x-i18n>';
        editPageDataTableHeader.appendChild(row);
        for (let i = 0; i < currentTest.columns.length; i++) {
            this.addColumnChild(i);
        }

        for (var i = 0; i < currentTest.data.length; i++) {
            this.addDataChild(i);
        }

        I18N.setPageTitle(currentTest.title);
        editPageView.classList.remove('hide');

        editDataModal.id = -1;
        editColumnModal.id = -1;
        
        this.updateModal(true);
    }

    /* Add a column in the UI */
    addColumnChild(index) {
        var column = currentTest.columns[index];
        var e = editColumnTemplate.content.cloneNode(true);
        e.querySelector('.test-column-text').textContent = column.name;
        e.children[0].onclick = () => {
            this.columnClickCallback(index);
        };
        e.children[0].onkeydown = onReturnClick;
        var deleteButton = e.querySelector('.column-delete-button');
        deleteButton.onclick = event => {
            event.stopPropagation();
            this.removeColumn(index);
        }
        deleteButton.onkeydown = onReturnClick;

        editPageColumnsList.appendChild(e);

        e = document.createElement('td');
        e.textContent = column.name;
        editPageDataTableHeader.children[0].appendChild(e);
    }

    /* Update a column in the UI */
    updateColumnChild(index) {
        var column = currentTest.columns[index];
        var e = editPageColumnsList.children[index];
        e.querySelector('.test-column-text').textContent = column.name;

        e = editPageDataTableHeader.children[0].children[index + 1]; // +1 because of the min td in first place
        e.textContent = column.name;
    }

    /* remove a column in the list */
    removeColumnChild(index) {
        editPageColumnsList.removeChild(editPageColumnsList.children[index]);
        this.resetColumnsClick();
    }

    /* reset onclick events in columns when the order is modified */
    resetColumnsClick() {
        for (let i = 0; i < currentTest.columns.length; i++) {
            editPageColumnsList.children[i].onclick = () => {
                this.columnClickCallback(i);
            };
        }
    }

    /* when a column is clicked */
    columnClickCallback(id) {
        currentURL.searchParams.set('column', id + 1);
        this.updateColumnModal(id);
    }

    /* Add a data in the UI */
    addDataChild(index) {
        var row = editDataTemplate.content.cloneNode(true);
        var e;
        for (var j = 0; j < currentTest.data[index].length; j++) {
            e = document.createElement('td');
            e.appendChild(currentTest.columns[j].getViewView(currentTest.data[index][j]));
            row.children[0].appendChild(e);
        }
        row.children[0].onclick = () => {
            this.dataClickCallback(index);
        }
        row.children[0].onkeydown = onReturnClick;
        var deleteButton = row.querySelector('.data-delete-button');
        deleteButton.onclick = event => {
            event.stopPropagation();
            this.removeData(index);
        }
        deleteButton.onkeydown = onReturnClick;
        editPageDataTableBody.appendChild(row);
    }

    /* Update a data in the UI */
    updateDataChild(index) {
        var row = editPageDataTableBody.children[index];
        var e;
        for (var j = 0; j < currentTest.columns.length; j++) {
            e = row.children[j + 1]; // +1 because of the min td at first
            e.replaceChild(currentTest.columns[j].getViewView(currentTest.data[index][j]), e.children[0]);
        }
    }

    /* Update a data in the UI */
    removeDataChild(index) {
        editPageDataTableBody.removeChild(editPageDataTableBody.children[index]);
        this.resetDataClick();
    }

    /* reset onclick events in data when the order is modified */
    resetDataClick() {
        for (let i = 0; i < currentTest.data.length; i++) {
            editPageDataTableBody.children[i].onclick = () => {
                this.dataClickCallback(i);
            };
            editPageDataTableBody.children[i].querySelector('.data-delete-button').onclick = event => {
                event.stopPropagation();
                this.removeData(i);
            }
        }
    }

    /* reload the entire UI of the data set */
    reloadData() {
        removeAllChildren(editPageDataTableHeader);
        removeAllChildren(editPageDataTableBody);

        var e;
        var row = editDataTemplate.content.cloneNode(true);
        row.querySelector('.min').innerHTML = '<x-i18n key="edit"></x-i18n>';
        for (var i = 0; i < currentTest.columns.length; i++) {
            e = document.createElement('td');
            e.textContent = currentTest.columns[i].name;
            row.children[0].appendChild(e);
        }
        editPageDataTableHeader.appendChild(row);

        for (var i = 0; i < currentTest.data.length; i++) {
            this.addDataChild(i);
        }
    }

    /* when a data is clicked */
    dataClickCallback(id) {
        currentURL.searchParams.set('data', id + 1);
        this.updateDataModal(id);
    }

    /* when the visibility of the page change */
    onvisibilitychange() {
        if (document.hidden) {
            this.saveTest();
            clearInterval(this.pageAutoSaveId);
            this.pageAutoSaveId = null;
        } else {
            this.pageAutoSaveId = setInterval(this.saveTest.bind(this), EDIT_AUTO_SAVE_TIME);
        }
    }

    /* when a key is press */
    onkeydown(event) {
        if (!event.altKey) return;

        switch (event.keyCode) {
            case KeyboardEvent.DOM_VK_RIGHT:
                if (Modal.currentModal === editColumnModal) {
                    this.nextColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == editDataModal) {
                    this.nextData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_LEFT:
                if (Modal.currentModal === editColumnModal) {
                    this.previousColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == editDataModal) {
                    this.previousData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_DOWN:
            case KeyboardEvent.DOM_VK_PAGE_DOWN:
                if (Modal.currentModal === editColumnModal) {
                    this.lastColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == editDataModal) {
                    this.lastData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_UP:
            case KeyboardEvent.DOM_VK_PAGE_UP:
                if (Modal.currentModal === editColumnModal) {
                    this.firstColumn();
                    event.preventDefault();
                } else if (Modal.currentModal == editDataModal) {
                    this.firstData();
                    event.preventDefault();
                }
                break;

            case KeyboardEvent.DOM_VK_N:
                event.preventDefault();
                if (Modal.currentModal === editColumnModal) {
                    this.addColumn();
                } else if (Modal.currentModal == editDataModal) {
                    this.addData();
                } else if (event.shiftKey) {
                    this.addColumn();
                } else {
                    this.addData();
                }
                break;

            case KeyboardEvent.DOM_VK_C:
                event.preventDefault();
                this.cancelButton();
                break;

            case KeyboardEvent.DOM_VK_S:
                event.preventDefault();
                this.saveButton();
                break;
        }
    }


    /* save the edited test */
    saveTest() {
        currentTest.title = editPageTitle.value;
        currentTest.description = editPageDescription.value;

        if (Modal.currentModal === editColumnModal) this.applyColumnModal();
        else if (Modal.currentModal == editDataModal) this.applyDataModal();

        DATABASE_MANAGER.updateTest(currentTest);
    }

    /* save the current data in modals */
    applyColumnModal() {
        if (editColumnModal.id >= 0) {
            var column = currentTest.columns[editColumnModal.id];
            column.name = editColumnModalTitle2.value;
            column.description = editColumnModalDescription.value;

            column.setEditColumnSettings(editColumnModalSettings);

            this.updateColumnChild(editColumnModal.id);
        }
    }

    applyDataModal() {
        if (editDataModal.id >= 0) {
            var row = currentTest.data[editDataModal.id];
            for (var i = 0; i < currentTest.columns.length; i++) {
                currentTest.columns[i].setValueFromView(row[i], editDataModalContent.children[i * 2 + 1]);
            }
            this.updateDataChild(editDataModal.id);
        }
    }

    /* callback for the cancel button */
    cancelButton() {
        Modal.showActionModal(
            'warning-lose-changes-title', 
            'warning-lose-changes-message', 
            {name: 'quit'}
        ).then(quit => {
            if (quit) {
                var id = currentTest.edit_id;
                currentTest = null;
                DATABASE_MANAGER.deleteTest(EDIT_KEY);
                if (id) UTILS.viewTestPage(id);
                else backToMain(true);
            }
        });
    }

    /**
     * When the save button is pressed.
     */
    saveButton() {
        this.saveTest();
        currentTest.registerModificationDate();

        if (currentTest.sync) {
            SyncManager.syncManager.saveTest(currentTest).then(() => {
                defaultPage.needReload = true;
                DATABASE_MANAGER.deleteTest(EDIT_KEY);
                const editId = currentTest.edit_id;
                currentTest = null;
                if (editId) {
                    UTILS.viewTestPage(editId);
                } else {
                    backToMain(true);
                }
            }).catch(error => {
                console.warn(error);
                Modal.showOkModal('sync-error-edit-title', 'sync-error-edit-message', {important: true});
            });
        } else {
            this.localSave();
        }
    }

    /**
     * Save locally the test
     */
    localSave() {
        defaultPage.needReload = true;
        if (currentTest.edit_id) {
            currentTest.id = currentTest.edit_id;
            delete currentTest.edit_id;
            DATABASE_MANAGER.deleteAllPlayContext(currentTest.id); // TODO: improve only make a reset data flag and save settings
            DATABASE_MANAGER.updateTest(currentTest).onsuccess = event => {
                UTILS.viewTestPage(event.target.result);
            };
            DATABASE_MANAGER.deleteTest(EDIT_KEY);
        } else {
            delete currentTest.id;
            DATABASE_MANAGER.addNewTest(currentTest).onsuccess = event => {
                UTILS.viewTestPage(event.target.result);
            };
            DATABASE_MANAGER.deleteTest(EDIT_KEY);
        }
    }

    /* add a column */
    addColumn() {
        var pos = currentTest.addColumn(new ColumnString(I18N.getTranslation("default-column-title")));
        this.addColumnChild(pos);
        this.columnClickCallback(pos);
        this.reloadData();
    }

    /* remove a column */
    removeColumn(index) {
        currentTest.removeColumn(index);
        this.removeColumnChild(index);
        this.reloadData();
    }

    /* add a data */
    addData() {
        var pos = currentTest.addData();
        this.addDataChild(pos);
        this.dataClickCallback(pos);
    }

    /* remove a data */
    removeData(index) {
        currentTest.removeData(index);
        this.removeDataChild(index);
    }

    /* update the modal from an id */
    updateColumnModal(id, addHistory=true) {
        if (Modal.currentModal !== editColumnModal) {
            editColumnModal.show(true, addHistory);
        }
        if (editColumnModal.id != id) {
            if (editColumnModal.id >= 0) this.applyColumnModal();
            editColumnModal.id = id;
            this.columnsModalNav.updateStatus(id <= 0,  id >= currentTest.columns.length - 1);
            
            var column = currentTest.columns[id];
            editColumnModalTitle1.textContent = column.name;
            editColumnModalTitle2.value = column.name;
            editColumnModalTitle2.focus();
            editColumnModalDescription.value = column.description;

            editColumnModalSettings.replaceChild(
                column.getEditColumnSettings(),
                editColumnModalSettings.children[0]
            );
        }
    }

    /* remove the current column shown */
    removeColumnModal() {
        var id = editColumnModal.id;
        this.removeColumn(id);
        editColumnModal.id = -1; // very important, required to not save the current remove data
        if (currentTest.columns.length > 0) {
            this.updateColumnModal(id > 0 ? id - 1 : 0);
        } else {
            Modal.hideModal();
        }
    }

    /* go to the next column */
    nextColumn() {
        if (editColumnModal.id < currentTest.columns.length - 1) {
            this.updateColumnModal(editColumnModal.id + 1); // don't add to history in order to not spam the history 
        }
    }

    /* go to the first column */
    firstColumn() {
        this.updateColumnModal(0);
    }

    /* go to the previous column*/
    previousColumn() {
        if (editColumnModal.id > 0) {
            this.updateColumnModal(editColumnModal.id - 1);
        }
    }

    /* go to the last column*/
    lastColumn() {
        this.updateColumnModal(currentTest.columns.length - 1);
    }

    /* close the column modal */
    closeColumnModal() {
        this.applyColumnModal();
        editColumnModal.id = -1; // to not save it again
    }

    /* update the modal of data */
    updateDataModal(id, addHistory=true) {
        if (Modal.currentModal != editDataModal) {
            editDataModal.show(true, addHistory);
        }
        if (editDataModal.id != id) {

            if (editDataModal.id >= 0) this.applyDataModal();
            editDataModal.id = id;
            this.dataModalNav.updateStatus(id <= 0, id >= currentTest.data.length - 1);

            var row = currentTest.data[id];
            editDataModalId.textContent = id + 1;
            removeAllChildren(editDataModalContent);
            var e;
            var column;
            for (var i = 0; i < row.length; i++) {
                column = currentTest.columns[i];
                e = document.createElement('h3');
                e.textContent = column.name + ":";
                e.classList = ['no-margin']
                editDataModalContent.appendChild(e);

                e = column.getEditView(row[i]);
                editDataModalContent.appendChild(e);
                if (i <= 0) e.focus();
            }
        }
    }

    /* remove the current data shown */
    removeDataModal() {
        var id = editDataModal.id;
        this.removeData(id);
        editDataModal.id = -1; // very important, required to not save the current remove data
        if (currentTest.data.length > 0) {
            this.updateDataModal(id > 0 ? id - 1 : 0);
        } else {
            Modal.hideModal();
        }
    }

    /* go to the next data*/
    nextData() {
        if (editDataModal.id < currentTest.data.length - 1) {
            this.updateDataModal(editDataModal.id + 1);
        }
    }

    /* go to the previous data */
    previousData() {
        if (editDataModal.id > 0) {
            this.updateDataModal(editDataModal.id - 1);
        }
    }

    /* go to the first data */
    firstData() {
        this.updateDataModal(0);
    }

    /* go to the last edit data */
    lastData() {
        this.updateDataModal(currentTest.data.length - 1);
    }

    /* close the data modal */
    closeDataModal() {
        this.applyDataModal();
        editDataModal.id = -1 // do not save it again
    }
}

PAGES.edit = new EditPage();


/* ####################### res/js/pages/index/play-card.js ########################*/

const playCardPageView = document.getElementById('play-card-page');

const playCardProgress = document.getElementById('play-card-progress');

const playCardCard = document.getElementById('play-card-card');
const playCardRestartTemplate = document.getElementById('play-card-restart-template');

const playCardSettingsButton = document.getElementById('play-card-settings-button');
const playCardShuffleButton = document.getElementById('play-card-shuffle-button');
const playCardShuffleButtonImage = document.getElementById('play-card-shuffle-button-image');

const playCardSetShowColumns = document.getElementById('play-card-set-show-columns'); 
const playCardSetRandomColumns = document.getElementById('play-card-set-random-columns'); 
const playCardSetAskColumns = document.getElementById('play-card-set-ask-columns'); 
const playCardSetHideColumns = document.getElementById('play-card-set-hide-columns'); 

const playCardSetNbColRandom = document.getElementById('play-card-set-nb-rand-col');
const playCardSetRandomSide = document.getElementById('play-card-set-random-side');
const playCardSetColumnName = document.getElementById('play-card-set-column-name');

const playCardSettingsModal = new Modal(document.getElementById('play-card-settings-modal'));

const playCardSetReset = document.getElementById('play-card-set-reset');

class PlayCardPage extends Page {

    static MAX_CACHE_SIZE = 10;
    static DB_GAME_ID = "card";

    constructor() {
        super(playCardPageView, 'play-card', true);

        /* a struct to hold state informations
         * testId:           the testId that is show
         * shuffleData:      if data should be shown in order or randomly
         * index:            the index of the current data show
         * data:             the order of row to show in case o shuffleData
         * columnsShow:      the list of columns to show (side 1)
         * columnsAsk:       the list of columns to ask (side 2) 
         * columnsRandom:    the list of columns to choose randomly
         * nbColumnsRandom:  the number of columns to choose randomly to be on the show side
         * randomSide:       choose a random side (columnsShow / columnsAsk)
         * showColumnName:   show the name of the columns in the card
         * columnsCache:     the cache of the columns selected: array of array with the first element representing the index of the element and after the list of columns to show and eventually, the list of columns to ask
         * showOtherside:    if the other side is shown
         */
        // this.context;

        new Sortable(playCardSetShowColumns, {
            group: 'play-card-set-columns',
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: this.onSettingsColumnMove.bind(this)
        });

        new Sortable(playCardSetRandomColumns, {
            group: 'play-card-set-columns',
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: this.onSettingsColumnMove.bind(this)
        });

        new Sortable(playCardSetAskColumns, {
            group: 'play-card-set-columns',
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: this.onSettingsColumnMove.bind(this)
        });

        new Sortable(playCardSetHideColumns, {
            group: 'play-card-set-columns',
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: this.onSettingsColumnMove.bind(this)
        });

        this.globalNavigation = new GlobalNavigation(playCardPageView);
        this.globalNavigation.onnext = this.nextCard.bind(this);
        this.globalNavigation.onprevious = this.previousCard.bind(this);

        playCardCard.onclick = this.turnCard.bind(this);
        playCardShuffleButton.onclick = e => {
            playCardShuffleButton.blur(); // stop focus in order to prevent getting the click event again when pressing space
            this.setShuffle(!this.context.shuffleData);
        };

        playCardSettingsButton.onclick = e => {
            playCardSettingsButton.blur(); // stop focus in order to prevent getting the click event again when pressing space
            this.showSettings();
        }

        playCardSetNbColRandom.onchange = this.onNumberColumnRandomChange.bind(this);
        playCardSetRandomSide.onchange = this.onSettingsRandomSideChanged.bind(this);
        playCardSetColumnName.onchange = this.onSettingsColumnNameChanged.bind(this);
        playCardSetReset.onclick = () => {
            Modal.hideModal();
            this.reset()
        };
    }

    /* when the page is loaded */
    onload() {
        I18N.setPageTitle(currentTest.title);
        playCardPageView.classList.remove('hide');

        const request = DATABASE_MANAGER.getPlayContext(currentTest.id, PlayCardPage);
        request.onsuccess = this.initialiseContextFromDB.bind(this);
        request.onerror = this.initialiseContext.bind(this);
    }

    onvisibilitychange() {
        if (document.hidden) {
            // save the context
            DATABASE_MANAGER.updatePlayContext(this.context);
        }
    }

    ondelete() {
        DATABASE_MANAGER.updatePlayContext(this.context);
        this.context = null; // save memory
    }

    /* when a key is press */
    onkeydown(event) {
        switch (event.keyCode) {
            case KeyboardEvent.DOM_VK_SPACE:
                event.preventDefault();
                this.turnCard();
                break;

            case KeyboardEvent.DOM_VK_LEFT:
                this.previousCard();
                break;

            case KeyboardEvent.DOM_VK_RIGHT:
                this.nextCard();
                break;
        }
    }

    /* initialise the context of the current card */
    initialiseContext() {
        this.context = {
            testId: currentTest.id,
            shuffleData: true,
            index: 0,
            data: [],
            columnsShow: [],
            columnsAsk: [],
            columnsRandom: [],
            columnsHide: [],
            nbColumnsRandom: 0,
            columnsCache: [],
            randomSide: true,
            showColumnName: true,
            showOtherside: false
        };

        var c;
        for (var i = 0; i < currentTest.columns.length; i++) {
            c = currentTest.columns[i];
            if (c.getSettings(Column.SET_CAN_BE_SHOW)) {
                if (c.getSettings(Column.SET_CAN_BE_ASK)) {
                    this.context.columnsRandom.push(i);
                } else {
                    this.context.columnsShow.push(i);
                }
            } else if (c.getSettings(Column.SET_CAN_BE_ASK)) {
                this.context.columnsAsk.push(i);
            } else {
                this.context.columnsHide.push(i);
            }
        }

        if (this.context.columnsShow.length <= 0) {
            this.context.nbColumnsRandom = 1;
        }

        if (this.context.columnsRandom.length === this.context.nbColumnsRandom) {
            this.context.columnsShow = this.context.columnsShow.concat(this.context.columnsRandom);
            this.context.nbColumnsRandom = [];
            this.context.nbColumnsRandom = 0;
        } else if (this.context.nbColumnsRandom === 0) {
            this.context.columnsAsk = this.context.columnsAsk.concat(this.context.columnsRandom);
            this.context.columnsRandom = [];
        } else {
            this.context.randomSide = false;
        }

        if ((this.context.columnsShow.length > 0 || this.context.nbColumnsRandom > 0) && 
            (this.context.columnsAsk.length > 0 || this.context.columnsRandom.length - this.context.nbColumnsRandom > 0)) {
            if (this.context.nbColumnsRandom === 0 && this.context.columnsShow.length === 1 && this.context.columnsAsk === 1) {
                this.context.showColumnName = false;
            }
        } else {
            backToMain(false);
        }

        this.initialise();
        this.setShuffle(this.context.shuffleData);
        DATABASE_MANAGER.addPlayContext(this.context, PlayCardPage);
    }

    /* initialise the context from the db */
    initialiseContextFromDB(event) {
        var cursor = event.target.result;
        if (cursor) {
            this.context = cursor.value;
            this.initialise();
            this.updateCard(this.context.index, false);
        } else {
            this.initialiseContext();
        }
    }

    /* initialise the UI from the context */
    initialise() {
        if (this.context.index < currentTest.data.length)
            playCardProgress.setProgress(this.context.index / (currentTest.data.length - 1), true);
        else
            playCardProgress.setProgress(1, true);
    }

    /* shuffle the data, and if reShuffle is true, make sure that the current index is correctly take in account */
    shuffleData(reShuffle = false) {
        if (reShuffle) {
            var i = this.context.data[this.context.index];
            this.context.data = randomShuffledNumberList(currentTest.data.length);
            var to = this.context.data.indexOf(i);
            var temp = this.context.data[to];
            this.context.data[to] = this.context.data[0];
            this.context.data[0] = temp;

            // keep selected columns of the current card
            var selected = this.getSelectedColumns(this.context.index);
            selected.unshift(0);
            this.context.columnsCache = [selected];
        } else {
            this.context.data = randomShuffledNumberList(currentTest.data.length);
        }
        if (this.context.index < this.context.data.length) this.updateCard(0);
    }

    /* initialise context.data so it is in order */
    notShuffledData() {
        var index = this.context.data[this.context.index];
        this.context.data = [];
        for (var i = 0; i < currentTest.data.length; i++) {
            this.context.data.push(i);
        }
        // keep selected columns of the current card
        var selected = this.getSelectedColumns(this.context.index);
        selected.unshift(index);
        this.context.columnsCache = [selected];
        if (this.context.index < this.context.data.length) {
            this.updateCard(index);
        }
    }

    /* set the shuffle of the data or not */
    setShuffle(shuffle) {
        this.context.shuffleData = shuffle;
        if (shuffle) {
            playCardShuffleButtonImage.src = '/WebDiakoluo/res/img/shuffle_on.svg';
            this.shuffleData(0 <= this.context.index && this.context.index < this.context.data.length);
        } else {
            playCardShuffleButtonImage.src = '/WebDiakoluo/res/img/shuffle.svg';
            this.notShuffledData();
        }
    }

    /* get the selected columns to show / ask from cache or generate new */
    getSelectedColumns(index) {
        for (var i = this.context.columnsCache.length - 1; i >= 0; i--) {
            if (this.context.columnsCache[i][0] === index)
                return [this.context.columnsCache[i][1], this.context.columnsCache[i][2]]
        }

        // generate new
        var columnsRandomShow = [];
        var columnsRandomShowSorted = [];
        var columnsShow = [];
        var columnsAsk = [];
        var columnsRemaining = this.context.nbColumnsRandom;
        var i;
        while (columnsRemaining > 0) {
            i = Math.floor(Math.random() * this.context.columnsRandom.length);
            if (columnsRandomShow.indexOf(i) === -1) {
                columnsRandomShow.push(i);
                columnsRemaining--;
            }
        }

        for (var i = 0; i < this.context.columnsRandom.length; i++) {
            if (columnsRandomShow.indexOf(i) === -1)
                columnsAsk.push(i);
            else {
                columnsRandomShowSorted.push(i);
            }
        }

        if (this.context.randomSide && Math.random() >= .5) {
            columnsShow = this.context.columnsAsk.concat(columnsAsk);
            columnsAsk = this.context.columnsShow.concat(columnsRandomShowSorted);
        } else {
            columnsShow = this.context.columnsShow.concat(columnsRandomShowSorted);
            columnsAsk = this.context.columnsAsk.concat(columnsAsk);
        }

        if (this.context.columnsCache.push([index, columnsShow, columnsAsk]) > PlayCardPage.MAX_CACHE_SIZE)
            this.context.columnsCache.shift();

        return [columnsShow, columnsAsk];
    }

    /* update the card at the index i, and show a face. resetSide: if the function should reset the side shown (used when the whole UI should reset) */
    updateCard(i, resetSide = true) {
        this.context.index = i;
        if (resetSide) this.context.showOtherside = false;
        this.globalNavigation.updateStatus(i <= 0 && this.context.shuffleData, false);
        
        if (i < this.context.data.length) {
            playCardProgress.setText(i + 1 + '/' + currentTest.data.length);
            playCardProgress.setProgress(i / (currentTest.data.length - 1));
        } else {
            i = currentTest.data.length;
            playCardProgress.setText(i + '/' + i);
            playCardProgress.setProgress(1);
        }
        this.updateUI();
    }

    /* update the UI of the card */
    updateUI() {
        if (this.cardChild) {
            playCardCard.removeChild(this.cardChild);
            this.cardChild = null;
        }

        if (this.context.index < this.context.data.length) {
            this.cardChild = document.createElement('div');
            var columns = this.getSelectedColumns(this.context.index)[this.context.showOtherside ? 1 : 0];
            var column;
            var data;
            var showName = this.context.showColumnName;
            var div;
            var e;
            for (var i = 0; i < columns.length; i++) {
                column = currentTest.columns[columns[i]];
                data = currentTest.data[this.context.data[this.context.index]][columns[i]];
                if (showName) {
                    div = document.createElement('div');
                    div.classList.add('card-column-name-parent');

                    e = document.createElement('h2');
                    e.classList.add('card-column-name');
                    e.textContent = column.name + ' :';
                    div.appendChild(e);

                    div.appendChild(column.getCardView(data));                

                    this.cardChild.appendChild(div);
                }  else {
                    this.cardChild.appendChild(column.getCardView(data));                
                }
            }
        } else {
            // show the restart panel
            this.cardChild = playCardRestartTemplate.content.cloneNode(true).children[0];
            this.cardChild.querySelector('#play-card-home-button').onclick = () => backToMain(true);
            this.cardChild.querySelector('#play-card-view-button').onclick = () => UTILS.viewTestPage();
            this.cardChild.querySelector('#play-card-restart-button').onclick = this.nextCard.bind(this);
            this.cardChild.querySelector('#play-card-grade-button').onclick = () => UTILS.evalTestPage();
        }
        
        playCardCard.appendChild(this.cardChild);
    }

    /* turn the card to see the other side */
    turnCard() {
        this.context.showOtherside = !this.context?.showOtherside ?? false;
        this.updateUI();
    }

    /* go to the next card */
    nextCard() {
        if (this.context.index < this.context.data.length - 1) {
            this.updateCard(this.context.index + 1);
        } else if (this.context.index < this.context.data.length) {
            this.context.index = this.context.index + 1;
            this.updateUI();
        } else {
            this.reset();
        }
    }

    /* go to the previous card */
    previousCard() {
        if (this.context.index > 0) {
            this.updateCard(this.context.index - 1);
        } else if (!this.context.shuffleData) {
            this.updateCard(this.context.data.length - 1);
        }
    }

    /* reset and start a new context */
    reset() {
        if (this.context.shuffleData) {
            this.shuffleData(this.context.index < currentTest.data.length - 1);
            this.updateCard(0);
        } else {
            this.updateCard(0);
        }
    }

    /* show the settings modal */
    showSettings() {
        playCardSettingsModal.show();

        removeAllChildren(playCardSetShowColumns);
        removeAllChildren(playCardSetRandomColumns);
        removeAllChildren(playCardSetAskColumns);
        removeAllChildren(playCardSetHideColumns);

        var e;
        for (var i = 0; i < this.context.columnsShow.length; i++) {
            e = document.createElement('div');
            e.classList = 'play-card-set-col-child';
            e.textContent = currentTest.columns[this.context.columnsShow[i]].name;
            playCardSetShowColumns.appendChild(e);
        }

        for (var i = 0; i < this.context.columnsRandom.length; i++) {
            e = document.createElement('div');
            e.classList = 'play-card-set-col-child';
            e.textContent = currentTest.columns[this.context.columnsRandom[i]].name;
            playCardSetRandomColumns.appendChild(e);
        }

        for (var i = 0; i < this.context.columnsAsk.length; i++) {
            e = document.createElement('div');
            e.classList = 'play-card-set-col-child';
            e.textContent = currentTest.columns[this.context.columnsAsk[i]].name;
            playCardSetAskColumns.appendChild(e);
        }

        for (var i = 0; i < this.context.columnsHide.length; i++) {
            e = document.createElement('div');
            e.classList = 'play-card-set-col-child';
            e.textContent = currentTest.columns[this.context.columnsHide[i]].name;
            playCardSetHideColumns.appendChild(e);
        }

        this.updateBoundColumnsRandom();

        playCardSetRandomSide.checked = this.context.randomSide;
        playCardSetColumnName.checked = this.context.showColumnName;
    }

    /* update the bounds of the random columns input */
    updateBoundColumnsRandom() {
        playCardSetNbColRandom.min = 0;
        playCardSetNbColRandom.max = this.context.columnsRandom.length;
        this.context.nbColumnsRandom = clamp(this.context.nbColumnsRandom, 0, this.context.columnsRandom.length);
        playCardSetNbColRandom.value = this.context.nbColumnsRandom;
    }

    /* when the input of random columns is changed */
    onNumberColumnRandomChange() {
        if (0 <= playCardSetNbColRandom.value && playCardSetNbColRandom.value <= this.context.columnsRandom.length) {
            this.context.nbColumnsRandom = playCardSetNbColRandom.value;
            this.resetCache();
        }
    }

    /* when a column is moved */
    onSettingsColumnMove(event) {
        var fromList = this.context[event.from.getAttribute('column-list')];
        var toList = this.context[event.to.getAttribute('column-list')];
        var data = fromList[event.oldDraggableIndex];
        fromList.splice(event.oldDraggableIndex, 1);
        toList.splice(event.newDraggableIndex, 0, data);

        if (event.from === playCardSetRandomColumns || event.to === playCardSetRandomColumns) {
            this.updateBoundColumnsRandom();
        }

        this.resetCache();
    }

    /* when the settings random side is changed */
    onSettingsRandomSideChanged() {
        this.context.randomSide = playCardSetRandomSide.checked;
        this.resetCache();
    }


    /* when the settings random side is changed */
    onSettingsColumnNameChanged() {
        this.context.showColumnName = playCardSetColumnName.checked;
        this.updateCard(this.context.index);
    }

    /* reset the columns cache but preserver the current card */
    resetCache() {
        // preserve current columns selected cache
        if (this.context.index < this.context.data.length) {
            var data = this.getSelectedColumns(this.context.index);
            data.unshift(this.context.index);
            this.context.columnsCache = [data];
        } else {
            this.context.columnsCache = [];
        }
    }
}

PAGES.play_card = new PlayCardPage();

/* ########################## res/js/pages/index/eval.js ##########################*/

const evalPageView = document.getElementById('eval-page');

const evalPageTestTitle = document.getElementById('eval-test-title');
const evalPageInputs = document.getElementById('eval-inputs');
const evalPageContinueButtonText = document.getElementById('eval-continue-button-text');

const evalProgressBar = document.getElementById('eval-progress');

/* A score context that hold the score of the session */
class ScoreContext {
    /* initialise */
    constructor() {
        this.score = 0;
        this.max = 0;
    }

    /* start a new session */
    reset() {
        this.score = 0;
        this.max = 0;
    }

    /* add a score */
    pushScore(score, max) {
        this.score += score;
        this.max += max;
    }
}

class EvalPage extends Page {
    constructor() {
        super(evalPageView, "eval", true);

        // define test context
        this.dataNumberToDo = null;
        this.numberColumnsRandomReveal = null;
        this.currentIndex = null;
        this.dataIndexes = null;
        this.answerIsShow = false;
        this.columnsAsked = null;
        this.score = new ScoreContext();
        this.evalInputs = [];
        this.randomInputs = 0;

        document.getElementById('eval-form').onsubmit = this.submitCallback.bind(this);
    }

    onload() {
        this.dataNumberToDo = currentURL.searchParams.get("data")?.split('-') ?? [];
        this.numberColumnsRandomReveal = Number(currentURL.searchParams.get("columns"));

        if (!Number.isInteger(this.numberColumnsRandomReveal)) {
            backToMain();
            return;
        }

        if (this.dataNumberToDo.length == 1) {
            this.dataNumberToDo = clamp(Number(this.dataNumberToDo[0]), 1, currentTest.data.length);
            if (!this.dataNumberToDo) {
                backToMain();
                return;
            }
        } else if (this.dataNumberToDo.length >= 2) {
            this.dataNumberToDo = [Number(this.dataNumberToDo[0]), Number(this.dataNumberToDo[1])]
            if (this.dataNumberToDo[0] && this.dataNumberToDo[1]) {
                this.dataNumberToDo = clamp(
                    Math.round(this.dataNumberToDo[0] * currentTest.data.length / this.dataNumberToDo[1]),
                    1, currentTest.data.length
                );
            } else {
                backToMain();
                return;
            }
        } else {
            backToMain();
            return;
        }

        this.numberColumnsRandomReveal = clamp(this.numberColumnsRandomReveal, 0, currentTest.columns.length - 1);

        this.currentIndex = 0;
        this.answerIsShow = false;
        this.dataIndexes = randomUniqueNumberList(this.dataNumberToDo, currentTest.data.length);

        this.score.reset();

        this.initialise();

        evalPageView.classList.remove('hide');
        I18N.setPageTitle(currentTest.title);
    }

    /* when a key is press */
    onkeydown(event) {
        if (event.keyCode === KeyboardEvent.DOM_VK_RETURN) {
            this.submitCallback(event);
        }
    }

    /* initialise the UI */
    initialise() {
        removeAllChildren(evalPageInputs);

        evalPageTestTitle.textContent = currentTest.title;
        this.evalInputs = [];
        this.randomInputs = 0;

        var show_only = 0;
        var ask_only = 0;

        var e;
        var c;
        var p;
        var set_show;
        var set_ask;
        var is_random;
        for (var i = 0; i < currentTest.columns.length; i++) {
            c = currentTest.columns[i];

            set_show = c.getSettings(Column.SET_CAN_BE_SHOW);
            set_ask = c.getSettings(Column.SET_CAN_BE_ASK);

            if (set_show || set_ask) {
                is_random = set_show && set_ask;
                e = document.createElement('h3');
                e.classList = ['no-margin'];
                e.textContent = c.name;
                evalPageInputs.appendChild(e);
                e = document.createElement('div');
                this.evalInputs.push(new EvalInput(i, c, e, set_show, set_ask, is_random));
                evalPageInputs.appendChild(e); // setup a dummy element

                if (is_random) this.randomInputs++;
                else if (set_show) {
                    this.numberColumnsRandomReveal--;
                    show_only++;
                }
                else {
                    ask_only++;
                }
            }
        }

        this.numberColumnsRandomReveal = clamp(
            this.numberColumnsRandomReveal, 
            show_only ? 0 : 1,
            ask_only ? this.randomInputs : this.randomInputs - 1
        );
        
        evalProgressBar.setProgress(0); // reset the progress bar
        this.update(this);
    }

    /* update the UI */
    update(applyScore = false) {
        var row = currentTest.data[this.dataIndexes[this.currentIndex]];
        
        if (this.answerIsShow) {
            var j = 0;
            var score = applyScore ? this.score : null;
            for (var i = 0; i < this.evalInputs.length; i++) {
                if (this.evalInputs[i].set_ask) {
                    if (!this.evalInputs[i].is_random || this.columnsAsked[j++]) {
                        this.evalInputs[i].showAnswer(row, score);
                    }
                }           
            }
            evalPageContinueButtonText.setAttribute('key', 'continue');
            evalProgressBar.setProgress((this.currentIndex + 1) / this.dataNumberToDo);
            evalProgressBar.setText(this.currentIndex + 1 + '/' + this.dataNumberToDo); // humanify
        } else {
            this.columnsAsked = new Array(currentTest.columns.length).fill(true);
            var i = this.numberColumnsRandomReveal;
            var j;
            while (i > 0) {
                j = randint(this.randomInputs);
                if (this.columnsAsked[j]) {
                    i--;
                    this.columnsAsked[j] = false;
                }
            }
            j = 0;
            for (var i = 0; i < this.evalInputs.length; i++) {
                if (this.evalInputs[i].is_random) {
                    if (this.columnsAsked[j++]) {
                        this.evalInputs[i].ask(row);
                    } else {
                        this.evalInputs[i].show(row);
                    }
                } else if (this.evalInputs[i].set_ask) {
                    this.evalInputs[i].ask(row);
                } else if (this.evalInputs[i].set_show) {
                    this.evalInputs[i].show(row);
                }
            }
            evalPageContinueButtonText.setAttribute('key', 'valid');

            var i = 0;
            var j = 0;
            while (true) {
                if (this.evalInputs[i].is_random) {
                    if (this.columnsAsked[j++]) {
                        break;
                    }
                } else if (this.evalInputs[i].set_ask) {
                    break;
                }
                if (++i >= this.evalInputs.length) {
                    i = 0;
                    break;
                }
            }

            this.evalInputs[i].view.focus();
 
            evalProgressBar.setProgress(this.currentIndex / this.dataNumberToDo);
            evalProgressBar.setText(this.currentIndex + 1 + '/' + this.dataNumberToDo); // humanify
        }
    }

    /* callback for the submit form */
    submitCallback(event) {
        event.preventDefault();

        if (this.answerIsShow) {
            this.answerIsShow = false;
            if (++this.currentIndex >= this.dataNumberToDo) {
                evalScorePage.setScore(this.score);
                setPage(evalScorePage);
            } else {
                this.update();
            }
        } else {
            this.answerIsShow = true;
            this.update(true);
        }
    }
}

class EvalInput {
    constructor(index, column, view, set_show, set_ask, is_random) {
        this.index = index;
        this.column = column;
        this.view = view;
        this.set_show = set_show;
        this.set_ask = set_ask;
        this.is_random = is_random;
    }

    /* ask the input */
    ask(row) {
        var e = this.column.getTestView(row[this.index]);
        evalPageInputs.replaceChild(
            e,
            this.view
        );
        this.view = e;
    }

    /* show the input */
    show(row) {
        var e = this.column.getViewView(row[this.index]);
        evalPageInputs.replaceChild(
            e,
            this.view
        );
        this.view = e;
    }

    /* show the answer */
    showAnswer(row, score) {
        var e = this.column.updateAnswerTestView(row[this.index], this.view, score);
        evalPageInputs.replaceChild(
            e,
            this.view
        );
        this.view = e;
    }
}

PAGES.eval = new EvalPage();

/* ##################### res/js/pages/index/eval-settings.js ######################*/

const evalSetPageView = document.getElementById('eval-settings-page');

const evalSetPageTestTitle = document.getElementById('eval-set-test-title');
const evalSetPageStartButton = document.getElementById('eval-set-start-button');

const evalSetPageNumberData = document.getElementById('eval-set-number-data');
const evalSetPageNumberColumns = document.getElementById('eval-set-number-column');
const evalSetPageNumberColumnsMax = document.getElementById('eval-set-number-column-max');

class EvalSettingsPage extends Page {

    constructor() {
        super(evalSetPageView, "eval-settings", true);
        this.currentTestId = -1;

        document.getElementById('eval-set-form').onsubmit = this.evalTest.bind(this);
    }

    onload() {
        if (!currentTest.isPlayable()) {
            backToMain(); // TODO dialog
            return;
        } 

        evalSetPageTestTitle.textContent = currentTest.title;

        this.setMinMaxColumns();

        var maxData = currentTest.data.length;
        var d;
        for (var i = 0; i < evalSetPageNumberData.options.length; i++) {
            d = Number(evalSetPageNumberData.options[i].value);
            if (d && d > maxData) {
                evalSetPageNumberData.options[i].disabled = true;
            }
        }

        evalSetPageView.classList.remove('hide');
        I18N.setPageTitle(currentTest.title);
    }

    /* set the minimum and the maximum of the columns input */
    setMinMaxColumns() {
        var min = 0;
        var max = 0; // a column must be show
        var askOnly = false;
        var columnCount = 0;
        var c;
        for (var i = 0; i < currentTest.columns.length; i++) {
            c = currentTest.columns[i];
            if (c.getSettings(Column.SET_CAN_BE_ASK)) {
                if (c.getSettings(Column.SET_CAN_BE_SHOW)) {
                    max++;
                } else {
                    askOnly = true;                    
                }     
                columnCount++;
            } else if (c.getSettings(Column.SET_CAN_BE_SHOW)) {
                min++;
                max++;
                columnCount++;
            }
        }

        if (!askOnly) {
            max--;
        }
        if (min <= 0)
            min = 1;

        evalSetPageNumberColumns.min = min;
        evalSetPageNumberColumns.max = max;
        evalSetPageNumberColumnsMax.textContent = columnCount;
    }

    /* eval the test */
    evalTest(event) {
        event.preventDefault(); // prevent send of form
        
        currentURL.searchParams.set("page", "eval");
        currentURL.searchParams.set("data", evalSetPageNumberData.value);
        currentURL.searchParams.set("columns", evalSetPageNumberColumns.value);
        history.pushState({}, "Eval", currentURL);
        loadPage();
    }
}

PAGES.eval_settings = new EvalSettingsPage();

/* ####################### res/js/pages/index/eval-score.js #######################*/

const MARK_20_FORMATER = new Intl.NumberFormat(navigator.language, {
    minimumIntegerDigits: 1,
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
});

const MARK_100_FORMATER = new Intl.NumberFormat(navigator.language, {
    style: "percent",
    minimumIntegerDigits: 1,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
});


const evalScoreView = document.getElementById('eval-score-page');
const evalScoreProgress = document.getElementById('eval-score-progress');
const evalScoreMajor = document.getElementById('eval-score-major');
const evalScoreMinor = document.getElementById('eval-score-minor');

class EvalScorePage extends Page {
    constructor() {
        super(evalScoreView, 'eval-score', true);
        document.getElementById('eval-score-restart').onclick = loadPage;
        document.getElementById('eval-score-menu').onclick = () => backToMain(false);
    }

    onload() {
        evalScoreView.classList.remove('hide');
        evalScoreProgress.setProgress(0, true);
    }

    setScore(scoreContext) {
        setTimeout(() => evalScoreProgress.setProgress(scoreContext.score / scoreContext.max), 500);

        evalScoreMajor.textContent = this.format20(scoreContext.score, scoreContext.max);
        evalScoreMinor.textContent = this.formatNormal(scoreContext.score, scoreContext.max);
    }

    format20(score, max) {
        return MARK_20_FORMATER.format(score / max * 20) + ' / 20'; 
    }

    format100(score, max) {
        return MARK_100_FORMATER.format(score / max); 
    }

    formatNormal(score, max) {
        return score + ' / ' + max;
    }
}

const evalScorePage = new EvalScorePage(); // internal page, not accesible via URL